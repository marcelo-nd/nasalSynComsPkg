% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nasalPkgFunctions.R
\name{pcoa_flex}
\alias{pcoa_flex}
\title{Flexible PCoA workflow with plotting and optional PERMANOVA}
\usage{
pcoa_flex(
  metab_df,
  metadata_df,
  sample_id_col = NULL,
  color_var,
  shape_var = NULL,
  ellipse_var = NULL,
  distance = c("bray", "euclidean"),
  preprocess = c("none", "hellinger", "sqrt"),
  k_axes = 2,
  ellipse = TRUE,
  min_n_for_ellipse = 3,
  label_points = FALSE,
  points_palette = NULL,
  ellipse_palette = NULL,
  color_var_leg_columns = 1,
  permanova_var = NULL,
  strata_var = NULL,
  permutations = 999
)
}
\arguments{
\item{metab_df}{Feature-by-sample table. Columns must be sample IDs. Values
are numeric (e.g., metabolite intensities/abundances).}

\item{metadata_df}{Sample metadata. Sample IDs can be provided via rownames
(default) or via \code{sample_id_col}.}

\item{sample_id_col}{Optional. Column name in \code{metadata_df} that contains
sample IDs. If \code{NULL}, rownames(\code{metadata_df}) are used as IDs.}

\item{color_var}{Metadata column name used to color points (treated as factor).}

\item{shape_var}{Optional. Metadata column name used to shape points (factor).}

\item{ellipse_var}{Optional. Metadata column name used to define ellipse groups
(factor). Ellipses are drawn only if \code{ellipse = TRUE}.}

\item{distance}{Distance metric. One of \code{"bray"} or \code{"euclidean"}.}

\item{preprocess}{Preprocessing applied before distance calculation. One of
\code{"none"}, \code{"hellinger"}, or \code{"sqrt"}.
\itemize{
\item \code{"hellinger"} uses \code{vegan::decostand(method = "hellinger")}
\item \code{"sqrt"} applies \code{sqrt()}
}}

\item{k_axes}{Number of PCoA axes to compute (minimum 2 are computed internally).}

\item{ellipse}{Logical. If \code{TRUE} and \code{ellipse_var} is provided,
draw 95\% normal ellipses via \code{ggplot2::stat_ellipse()}.}

\item{min_n_for_ellipse}{Minimum group size required (per \code{ellipse_var}
level) to draw ellipses. Groups with fewer samples are skipped.}

\item{label_points}{Logical. If \code{TRUE}, label points with sample IDs using
\code{ggrepel::geom_text_repel()}.}

\item{points_palette}{Optional named character vector mapping
\code{levels(metadata_df[[color_var]])} to colors, passed to
\code{scale_color_manual()}.}

\item{ellipse_palette}{Optional named character vector mapping
\code{levels(metadata_df[[ellipse_var]])} to colors when ellipses use a
separate color scale.}

\item{color_var_leg_columns}{Integer. Number of legend columns for the color
legend (points).}

\item{permanova_var}{Optional. Metadata column to test in PERMANOVA (single-term).
Internally mapped to \code{.__var} and tested as \code{dd ~ .__var}.}

\item{strata_var}{Optional. Metadata column used as a blocking factor (strata)
in PERMANOVA (e.g., SynCom).}

\item{permutations}{Integer. Number of permutations for PERMANOVA.}
}
\value{
A named list with:
\itemize{
\item \code{pcoa}: \code{cmdscale()} result (includes eigenvalues and points)
\item \code{explained}: percent variance explained for positive eigenvalues
\item \code{scores}: data.frame with PCoA coordinates + metadata + Sample
\item \code{plot}: ggplot object of PCoA ordination
\item \code{dist}: \code{vegan::vegdist} distance object
\item \code{dist_mat}: distance matrix as a base \code{matrix}
\item \code{permanova}: \code{adonis2} result or \code{NULL}
\item \code{settings}: list of key settings used for reproducibility
}
}
\description{
Computes a Principal Coordinates Analysis (PCoA) from a feature table
(e.g., metabolomics) and sample metadata, returning ordination results,
variance explained, plotting-ready scores, a ggplot object, the distance
object/matrix, and an optional single-factor PERMANOVA.
}
\details{
This function:
\itemize{
\item aligns samples between \code{metab_df} columns and \code{metadata_df}
\item optionally preprocesses data (none / sqrt / hellinger)
\item computes Bray-Curtis or Euclidean distances
\item runs \code{cmdscale()} PCoA (with \code{add = TRUE})
\item makes a \code{ggplot2} ordination plot with optional ellipses and labels
\item optionally runs \code{vegan::adonis2()} PERMANOVA for one variable
}

\strong{Sample alignment}
Samples are intersected between \code{colnames(metab_df)} and metadata sample
IDs. The feature table is subset to overlapping samples and metadata is
re-ordered to match the feature table column order.

\strong{Distance and preprocessing constraints}
\itemize{
\item Bray-Curtis requires non-negative values; the function errors if any
negative entries are present.
\item Hellinger and sqrt preprocessing require non-negative values.
}

\strong{Ellipses}
Ellipses are drawn only for groups with at least \code{min_n_for_ellipse}
samples. If \code{ellipse_var != color_var}, a second color scale is created
using \code{ggnewscale::new_scale_color()} (loaded on demand).

\strong{PERMANOVA}
If \code{permanova_var} is provided, rows with missing values in the tested
variable (and in \code{strata_var}, if provided) are dropped before running
\code{vegan::adonis2()}. The distance object is subset accordingly.
}
\examples{
\dontrun{
res <- pcoa_flex(
  metab_df = feat_table,
  metadata_df = md,
  color_var = "Cluster",
  shape_var = "Time",
  ellipse_var = "Cluster",
  distance = "bray",
  preprocess = "hellinger",
  permanova_var = "Cluster",
  strata_var = "SynCom"
)
res$plot
res$permanova
}

}
