% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nasalPkgFunctions.R
\name{compute_lfc_and_stars}
\alias{compute_lfc_and_stars}
\title{Compute log2 fold-changes vs control and significance "stars" (FDR + effect-size gated)}
\usage{
compute_lfc_and_stars(
  mat_raw,
  mat_mean,
  base_names,
  control_prefix = "CTRL",
  alpha = 0.05,
  lfc_gate = 2,
  pseudocount_test = 1,
  pseudocount_disp = 1e-08
)
}
\arguments{
\item{mat_raw}{Numeric matrix of metabolites x replicate-columns (raw replicate values).
Row names must identify metabolites.}

\item{mat_mean}{Numeric matrix of metabolites x sample-prefix columns (replicate means).
Column names are expected to be the unique sample prefixes (including control).}

\item{base_names}{Named character vector mapping replicate column names to base sample
prefixes (names = replicate columns, values = prefixes). Used to select control and
treatment replicate columns in \code{mat_raw}.}

\item{control_prefix}{Character. The sample prefix in \code{mat_mean} (and \code{base_names})
that defines the control condition (default \code{"CTRL"}).}

\item{alpha}{Numeric. FDR cutoff applied to BH-adjusted p-values (default \code{0.05}).}

\item{lfc_gate}{Numeric. Minimum absolute LFC required to mark significance
(default \code{2}, i.e., 4-fold on the original scale).}

\item{pseudocount_test}{Numeric. Pseudocount added to replicate intensities in \code{mat_raw}
before log2 transform for t-tests. Helps handle zeros (default \code{1}).}

\item{pseudocount_disp}{Numeric. Pseudocount added to means in \code{mat_mean} when computing
the heatmap LFC. Kept small to minimally perturb ratios (default \code{1e-8}).}
}
\value{
A list with:
\itemize{
\item \code{lfc}: numeric matrix of metabolites x treatment prefixes (control removed).
\item \code{stars}: character matrix of same dimensions as \code{lfc}, containing "*" for
significant entries and "" otherwise.
}
}
\description{
Computes (i) a log2 fold-change (LFC) matrix comparing each treatment sample
(prefix) against a specified control prefix using replicate means, and (ii) a
corresponding matrix of significance markers ("*") based on replicate-level
Welch t-tests with Benjamini-Hochberg FDR correction, additionally gated by
a minimum absolute LFC threshold.
}
\details{
The intent is to match what is visualized in a heatmap:
\itemize{
\item LFC values are computed from \code{mat_mean} (means across replicates),
using \code{pseudocount_disp}.
\item Significance is computed from replicate-level data in \code{mat_raw}
after log2-transform with \code{pseudocount_test}, then BH-adjusted, and
only called significant if both FDR and effect-size gates are passed.
}

\strong{LFC definition (heatmap)}
For each metabolite \eqn{m} and treatment sample \eqn{s}:
\deqn{LFC_{m,s} = \log_2\left(\frac{\bar{x}_{m,s} + \epsilon}{\bar{x}_{m,ctrl} + \epsilon}\right)}
where \eqn{\bar{x}} are replicate means from \code{mat_mean} and \eqn{\epsilon = pseudocount_disp}.
The control column is dropped from the returned LFC matrix.

\strong{Significance testing}
For each treatment prefix \code{smpl}, replicate columns are selected via \code{base_names}.
Values are transformed using \code{log2(value + pseudocount_test)} and compared against the
corresponding control replicates with Welch's t-test (\code{var.equal = FALSE}).
BH correction is applied across metabolites for each treatment-vs-control comparison.

\strong{Gating}
A metabolite is marked with "*" for a given treatment if:
\itemize{
\item \code{padj < alpha}, and
\item \code{abs(LFC_heatmap) >= lfc_gate}
}
where \code{LFC_heatmap} is taken from the same LFC matrix used for plotting.

Metabolites with insufficient non-missing replicate values (<2 per group) yield \code{NA}
p-values and are never starred.
}
\examples{
\dontrun{
# mat_raw: metabolites x replicate columns (e.g., A_1, A_2, CTRL_1, CTRL_2)
# mat_mean: metabolites x prefixes (e.g., A, CTRL)
res <- compute_lfc_and_stars(
  mat_raw = mat_raw,
  mat_mean = mat_mean,
  base_names = base_names,
  control_prefix = "CTRL",
  alpha = 0.05,
  lfc_gate = 1
)
res$lfc
res$stars
}

}
