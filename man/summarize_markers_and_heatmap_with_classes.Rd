% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nasalPkgFunctions.R
\name{summarize_markers_and_heatmap_with_classes}
\alias{summarize_markers_and_heatmap_with_classes}
\title{Summarize limma cluster markers and draw a heatmap annotated with SIRIUS classes}
\usage{
summarize_markers_and_heatmap_with_classes(
  metab_df,
  metadata_df,
  sample_id_col = NULL,
  cluster_var,
  sirius_df,
  id_col = "row.ID",
  class_cols = c("SIRIUS_ClassyFire.class", "SIRIUS_ClassyFire.most.specific.class",
    "SIRIUS_ClassyFire.subclass", "SIRIUS_ClassyFire.level.5"),
  id_pattern = "^X(\\\\d+).*",
  limma_res,
  top_n = 15,
  p_adj_thresh = 0.05,
  min_logFC = 0,
  log_transform = TRUE,
  log_offset = 1,
  scale_rows = TRUE,
  heatmap_colors = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(101),
  cluster_colors = NULL,
  class_na_label = "Unclassified",
  class_na_color = "#BDBDBD",
  out_file = NULL,
  out_width = 9,
  out_height = 12,
  out_dpi = 300,
  c_legend_ncol = 2,
  r_legend_ncol = 2,
  legend_side = "bottom",
  merge_legends = FALSE
)
}
\arguments{
\item{metab_df}{Metabolite feature table with metabolites as rows and samples as
columns. Column names must be sample IDs.}

\item{metadata_df}{Sample metadata data frame containing \code{cluster_var} and
sample identifiers (rownames or \code{sample_id_col}).}

\item{sample_id_col}{Optional. Column name in \code{metadata_df} holding sample IDs.
If \code{NULL}, non-empty rownames are used.}

\item{cluster_var}{Character. Metadata column defining sample clusters (e.g.,
\code{"ATTRIBUTE_Cluster"}).}

\item{sirius_df}{Data frame of SIRIUS annotations, including an identifier column
(see \code{id_col}) and one or more class columns (see \code{class_cols}).}

\item{id_col}{Character. Column name in \code{sirius_df} containing the identifier
used to match metabolites to SIRIUS rows (default \code{"row.ID"}).}

\item{class_cols}{Character vector of SIRIUS/ClassyFire columns to use as row
annotations. Only columns present in \code{sirius_df} are used.}

\item{id_pattern}{Regular expression used to extract an ID from metabolite rownames
of \code{metab_df}. The default \code{"^X(\\\\d+).*"} extracts the first integer
after an \code{"X"} (e.g., \code{"X1234_something"} \eqn{\rightarrow} \code{"1234"}).}

\item{limma_res}{Result list from \code{limma_markers_by_cluster_general()}, which must
contain \code{$markers_one_vs_rest}.}

\item{top_n}{Integer. Number of top markers to select per cluster after filtering.}

\item{p_adj_thresh}{Numeric. Adjusted p-value cutoff (\code{adj.P.Val}) used to filter
markers before selecting \code{top_n}.}

\item{min_logFC}{Numeric. Minimum \code{logFC} required to retain a marker (default \code{0}).}

\item{log_transform}{Logical. If \code{TRUE}, apply \code{log(X + log_offset)} to the
selected matrix before plotting. Negative values (if any) are shifted to be non-negative.}

\item{log_offset}{Numeric. Offset used in the log transform (default \code{1}).}

\item{scale_rows}{Logical. If \code{TRUE}, row-scale selected metabolites for display
(z-scores across samples). Non-finite z-scores are set to 0.}

\item{heatmap_colors}{Deprecated/unused in the current implementation (color mapping is
defined via \code{circlize::colorRamp2()}).}

\item{cluster_colors}{Optional named vector mapping cluster levels to colors for the
column annotation. If \code{NULL}, a \code{RColorBrewer::Set2} palette is used.}

\item{class_na_label}{Character. Placeholder label used when SIRIUS class annotations are
missing/blank (default \code{"Unclassified"}).}

\item{class_na_color}{Color used for \code{class_na_label} (default \code{"#BDBDBD"}).}

\item{out_file}{Optional. If provided, saves the heatmap to this file path. Supported
extensions: \code{pdf}, \code{svg}, \code{png}, \code{tif/tiff}, \code{jpg/jpeg}.}

\item{out_width}{Numeric. Output width in inches.}

\item{out_height}{Numeric. Output height in inches.}

\item{out_dpi}{Integer. DPI for raster outputs (PNG/JPG/TIFF).}

\item{c_legend_ncol}{Integer. Number of legend columns for column annotations.}

\item{r_legend_ncol}{Integer. Number of legend columns for row annotations.}

\item{legend_side}{Character. Legend placement for \code{ComplexHeatmap::draw()}:
\code{"bottom"}, \code{"top"}, \code{"left"}, or \code{"right"}.}

\item{merge_legends}{Logical. If \code{TRUE}, merge heatmap and annotation legends into a
single legend block (passed to \code{draw(merge_legend = ...)}).}
}
\value{
A list with:
\itemize{
\item \code{heatmap}: \code{ComplexHeatmap::Heatmap} object.
\item \code{X_display}: matrix used for plotting (optionally row-scaled).
\item \code{X_values}: selected metabolite matrix values before scaling.
\item \code{ann_col}: column annotation data.frame (clusters).
\item \code{ann_row}: row annotation data.frame (SIRIUS classes).
\item \code{annotation_colors}: list of palettes used for annotations (for reference).
\item \code{top_table}: data.frame of selected top markers per cluster.
\item \code{selected_metabolites}: character vector of metabolite IDs used in the heatmap.
}
}
\description{
Selects top-N marker metabolites per cluster from a limma one-vs-rest result,
aligns the metabolite matrix to metadata, optionally log-transforms and row-scales
the selected metabolite profiles, and renders a \code{ComplexHeatmap} heatmap
with:
\itemize{
\item column annotations for sample cluster membership, and
\item row annotations derived from SIRIUS/ClassyFire chemical class columns.
}
}
\details{
Optionally saves the heatmap to a file (PDF/SVG/PNG/TIFF/JPG) with configurable
dimensions, DPI, legend placement, and legend merging.

\strong{Step A: Sample alignment}
Samples are intersected between \code{colnames(metab_df)} and metadata IDs. The
metabolite matrix and metadata are subset and ordered consistently, and a column
annotation data frame is created with \code{Cluster = factor(metadata_df[[cluster_var]])}.

\strong{Step B: SIRIUS row annotations}
Metabolite rownames are mapped to SIRIUS IDs using \code{id_pattern}. Only distinct
SIRIUS rows per ID are kept. Selected class columns are joined onto metabolites.
Missing/blank class values are replaced by \code{class_na_label}.

\strong{Step C: Marker selection}
Uses \code{limma_res$markers_one_vs_rest} and filters by \code{adj.P.Val <= p_adj_thresh}
and \code{logFC >= min_logFC}. For each target cluster, the top \code{top_n} metabolites
are selected by increasing adjusted p-value and decreasing logFC.

\strong{Step D: Heatmap}
Columns are ordered by cluster. If \code{scale_rows = TRUE}, z-scores are computed per
metabolite across samples and used for the heatmap values. A symmetric blue-white-red
color mapping is built around 0. Column and row annotations are added with independent
legend column controls.
}
\examples{
\dontrun{
res <- summarize_markers_and_heatmap_with_classes(
  metab_df = metab_mat,
  metadata_df = md,
  sample_id_col = "Sample",
  cluster_var = "ATTRIBUTE_Cluster",
  sirius_df = sirius_tbl,
  limma_res = limma_out,
  top_n = 10,
  p_adj_thresh = 0.05,
  scale_rows = TRUE,
  out_file = "markers_heatmap.pdf"
)
res$heatmap
res$top_table
}

}
