% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nasalPkgFunctions.R
\name{limma_markers_by_cluster_general}
\alias{limma_markers_by_cluster_general}
\title{Identify metabolite markers by cluster using limma (one-vs-rest and optional pairwise)}
\usage{
limma_markers_by_cluster_general(
  metab_df,
  metadata_df,
  sample_id_col = NULL,
  cluster_var,
  covariates = NULL,
  block_var = NULL,
  log_transform = TRUE,
  log_offset = 1,
  do_pairwise = TRUE,
  adjust_method = "BH"
)
}
\arguments{
\item{metab_df}{Metabolite feature table with metabolites as rows and samples as
columns. Column names must be sample IDs.}

\item{metadata_df}{Sample metadata data frame. Sample IDs are aligned to
\code{metab_df} using \code{.align_to_metadata()}.}

\item{sample_id_col}{Optional. Column in \code{metadata_df} containing sample IDs.
If \code{NULL}, \code{.align_to_metadata()} will try \code{"Sample"} or rownames.}

\item{cluster_var}{Character. Metadata column defining clusters (e.g.,
\code{"ATTRIBUTE_Cluster"}). Treated as a factor.}

\item{covariates}{Optional character vector of metadata columns to include as
covariates (e.g., \code{c("ATTRIBUTE_Time")}). Character columns are coerced
to factors; numeric columns are kept numeric. Dummy coding is generated via
\code{model.matrix(~ 0 + ., data = cov_df)}.}

\item{block_var}{Optional character. Metadata column defining a blocking factor
for duplicate correlation (e.g., \code{"ATTRIBUTE_SynCom"}). If provided,
\code{duplicateCorrelation} is used and the model is fit with \code{block}.}

\item{log_transform}{Logical. If \code{TRUE}, apply \code{log(X + log_offset)} to
the aligned data prior to modeling (default \code{TRUE}). If data contain
negative values, they are shifted to be non-negative before logging.}

\item{log_offset}{Numeric. Offset added before log transform (default \code{1}).}

\item{do_pairwise}{Logical. If \code{TRUE}, also compute all pairwise contrasts
among cluster levels (default \code{TRUE}).}

\item{adjust_method}{Multiple testing adjustment passed to \code{limma::topTable()}
(default \code{"BH"}).}
}
\value{
A list with:
\itemize{
\item \code{markers_one_vs_rest}: data frame of limma results for one-vs-rest
contrasts. Includes \code{Metabolite}, \code{Contrast}, and \code{TargetCluster}.
\item \code{markers_pairwise}: data frame of limma results for pairwise contrasts,
or \code{NULL} if disabled.
\item \code{duplicate_correlation}: estimated consensus correlation (or \code{NA}
if no blocking was used).
\item \code{design}: the final design matrix used for modeling.
\item \code{cluster_levels}: character vector of cluster level names.
\item \code{used_args}: list of key arguments used for reproducibility.
}
}
\description{
Fits a linear model per metabolite using \code{limma} to test for differential
abundance across clusters, optionally adjusting for covariates and optionally
accounting for within-block correlation (e.g., repeated measures / SynCom blocks)
using \code{limma::duplicateCorrelation()}.
}
\details{
The function returns:
\itemize{
\item one-vs-rest contrasts for each cluster (each cluster vs the average of all others),
\item optional pairwise contrasts among all cluster levels,
\item the design matrix used and the estimated duplicate correlation (if any).
}

\strong{Design}
The cluster effect is encoded as a no-intercept design:
\code{~ 0 + cluster}, producing one coefficient per cluster level. If covariates
are provided, their dummy-coded columns are appended to the design matrix.

\strong{One-vs-rest contrasts}
For \eqn{K} clusters, each contrast is:
\deqn{c_i = 1 \text{ for cluster } i,\;\; -1/(K-1) \text{ for all other clusters}}
so that each cluster is compared to the average of the rest.

\strong{Pairwise contrasts}
If enabled, all combinations of cluster levels are tested as \code{B - A}.

\strong{Blocking / correlation}
If \code{block_var} is provided, \code{duplicateCorrelation()} estimates a
consensus correlation to account for non-independence within blocks, and that
correlation is used in \code{lmFit()}.
}
\examples{
\dontrun{
res <- limma_markers_by_cluster_general(
  metab_df = metab_mat,
  metadata_df = md,
  cluster_var = "ATTRIBUTE_Cluster",
  covariates = c("ATTRIBUTE_Time"),
  block_var = "ATTRIBUTE_SynCom",
  log_transform = TRUE,
  log_offset = 1,
  do_pairwise = TRUE
)
head(res$markers_one_vs_rest)
head(res$markers_pairwise)
}

}
